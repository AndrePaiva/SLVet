(function(e){e.jgrid.extend({searchGrid:function(t){t=e.extend({recreateFilter:false,drag:true,sField:"searchField",sValue:"searchString",sOper:"searchOper",sFilter:"filters",loadDefaults:true,beforeShowSearch:null,afterShowSearch:null,onInitializeSearch:null,closeAfterSearch:false,closeAfterReset:false,closeOnEscape:false,multipleSearch:false,cloneSearchRowOnAdd:true,sopt:null,stringResult:undefined,onClose:null,useDataProxy:false,overlay:true},e.jgrid.search,t||{});return this.each(function(){function s(t,n){var r=t.p.postData[n.sFilter];if(typeof r=="string"){r=e.jgrid.parse(r)}if(r){if(r.groupOp){t.SearchFilter.setGroupOp(r.groupOp)}if(r.rules){var i,s=0,o=r.rules.length,u=false;for(;s<o;s++){i=r.rules[s];if(i.field!==undefined&&i.op!==undefined&&i.data!==undefined){u=t.SearchFilter.setFilter({sfref:t.SearchFilter.$.find(".sf:last"),filter:e.extend({},i)});if(u){t.SearchFilter.add()}}}}}}function o(r){if(t.onClose){var i=t.onClose(r);if(typeof i=="boolean"&&!i){return}}r.hide();if(t.overlay===true){e(".jqgrid-overlay:first","#gbox_"+n.p.id).hide()}}function u(){var i=e(".ui-searchFilter").length;if(i>1){var s=e("#"+r).css("zIndex");e("#"+r).css({zIndex:parseInt(s,10)+i})}e("#"+r).show();if(t.overlay===true){e(".jqgrid-overlay:first","#gbox_"+n.p.id).show()}try{e(":input:visible","#"+r)[0].focus()}catch(o){}}function a(i){var s=i!==undefined,u=e("#"+n.p.id),a={};if(t.multipleSearch===false){a[t.sField]=i.rules[0].field;a[t.sValue]=i.rules[0].data;a[t.sOper]=i.rules[0].op;if(a.hasOwnProperty(t.sFilter)){delete a[t.sFilter]}}else{a[t.sFilter]=i;e.each([t.sField,t.sValue,t.sOper],function(e,t){if(a.hasOwnProperty(t)){delete a[t]}})}u[0].p.search=s;e.extend(u[0].p.postData,a);u.trigger("reloadGrid",[{page:1}]);if(t.closeAfterSearch){o(e("#"+r))}}function f(i){var s=i&&i.hasOwnProperty("reload")?i.reload:true,u=e("#"+n.p.id),a={};u[0].p.search=false;if(t.multipleSearch===false){a[t.sField]=a[t.sValue]=a[t.sOper]=""}else{a[t.sFilter]=""}e.extend(u[0].p.postData,a);if(s){u.trigger("reloadGrid",[{page:1}])}if(t.closeAfterReset){o(e("#"+r))}}var n=this;if(!n.grid){return}var r="fbox_"+n.p.id,i=true;if(e.fn.searchFilter){if(t.recreateFilter===true){e("#"+r).remove()}if(e("#"+r).html()!==null){if(e.isFunction(t.beforeShowSearch)){i=t.beforeShowSearch(e("#"+r));if(typeof i=="undefined"){i=true}}if(i===false){return}u();if(e.isFunction(t.afterShowSearch)){t.afterShowSearch(e("#"+r))}}else{var l=[],c=e("#"+n.p.id).jqGrid("getGridParam","colNames"),h=e("#"+n.p.id).jqGrid("getGridParam","colModel"),d=["eq","ne","lt","le","gt","ge","bw","bn","in","ni","ew","en","cn","nc"],v,m,g,y=[];if(t.sopt!==null){g=0;for(v=0;v<t.sopt.length;v++){if((m=e.inArray(t.sopt[v],d))!=-1){y[g]={op:t.sopt[v],text:t.odata[m]};g++}}}else{for(v=0;v<d.length;v++){y[v]={op:d[v],text:t.odata[v]}}}e.each(h,function(n,r){var i=typeof r.search==="undefined"?true:r.search,s=r.hidden===true,o=e.extend({},{text:c[n],itemval:r.index||r.name},this.searchoptions),u=o.searchhidden===true;if(typeof o.sopt!=="undefined"){g=0;o.ops=[];if(o.sopt.length>0){for(v=0;v<o.sopt.length;v++){if((m=e.inArray(o.sopt[v],d))!=-1){o.ops[g]={op:o.sopt[v],text:t.odata[m]};g++}}}}if(typeof this.stype==="undefined"){this.stype="text"}if(this.stype=="select"){if(o.dataUrl!==undefined){}else{var a;if(o.value){a=o.value}else if(this.editoptions){a=this.editoptions.value}if(a){o.dataValues=[];if(typeof a==="string"){var f=a.split(";"),h;for(v=0;v<f.length;v++){h=f[v].split(":");o.dataValues[v]={value:h[0],text:h[1]}}}else if(typeof a==="object"){v=0;for(var y in a){if(a.hasOwnProperty(y)){o.dataValues[v]={value:y,text:a[y]};v++}}}}}}if(u&&i||i&&!s){l.push(o)}});if(l.length>0){e("<div id='"+r+"' role='dialog' tabindex='-1'></div>").insertBefore("#gview_"+n.p.id);if(t.stringResult===undefined){t.stringResult=t.multipleSearch}n.SearchFilter=e("#"+r).searchFilter(l,{groupOps:t.groupOps,operators:y,onClose:o,resetText:t.Reset,searchText:t.Find,windowTitle:t.caption,rulesText:t.rulesText,matchText:t.matchText,onSearch:a,onReset:f,stringResult:t.stringResult,ajaxSelectOptions:e.extend({},e.jgrid.ajaxOptions,n.p.ajaxSelectOptions||{}),clone:t.cloneSearchRowOnAdd});e(".ui-widget-overlay","#"+r).remove();if(n.p.direction=="rtl"){e(".ui-closer","#"+r).css("float","left")}if(t.drag===true){e("#"+r+" table thead tr:first td:first").css("cursor","move");if(jQuery.fn.jqDrag){e("#"+r).jqDrag(e("#"+r+" table thead tr:first td:first"))}else{try{e("#"+r).draggable({handle:e("#"+r+" table thead tr:first td:first")})}catch(b){}}}if(t.multipleSearch===false){e(".ui-del, .ui-add, .ui-del, .ui-add-last, .matchText, .rulesText","#"+r).hide();e("select[name='groupOp']","#"+r).hide()}if(t.multipleSearch===true&&t.loadDefaults===true){s(n,t)}if(e.isFunction(t.onInitializeSearch)){t.onInitializeSearch(e("#"+r))}if(e.isFunction(t.beforeShowSearch)){i=t.beforeShowSearch(e("#"+r));if(typeof i=="undefined"){i=true}}if(i===false){return}u();if(e.isFunction(t.afterShowSearch)){t.afterShowSearch(e("#"+r))}if(t.closeOnEscape===true){e("#"+r).keydown(function(t){if(t.which==27){o(e("#"+r))}if(t.which==13){e(".ui-search",this).click()}})}}}}})},updateGridRows:function(t,n,r){var i,s=false,o;this.each(function(){var u=this,a,f,l,c;if(!u.grid){return false}if(!n){n="id"}if(t&&t.length>0){e(t).each(function(t){l=this;f=u.rows.namedItem(l[n]);if(f){c=l[n];if(r===true){if(u.p.jsonReader.repeatitems===true){if(u.p.jsonReader.cell){l=l[u.p.jsonReader.cell]}for(var h=0;h<l.length;h++){a=u.formatter(c,l[h],h,l,"edit");o=u.p.colModel[h].title?{title:e.jgrid.stripHtml(a)}:{};if(u.p.treeGrid===true&&i==u.p.ExpandColumn){e("td:eq("+h+") > span:first",f).html(a).attr(o)}else{e("td:eq("+h+")",f).html(a).attr(o)}}s=true;return true}}e(u.p.colModel).each(function(t){i=r===true?this.jsonmap||this.name:this.name;if(l[i]!==undefined){a=u.formatter(c,l[i],t,l,"edit");o=this.title?{title:e.jgrid.stripHtml(a)}:{};if(u.p.treeGrid===true&&i==u.p.ExpandColumn){e("td:eq("+t+") > span:first",f).html(a).attr(o)}else{e("td:eq("+t+")",f).html(a).attr(o)}s=true}})}})}});return s},filterGrid:function(t,n){n=e.extend({gridModel:false,gridNames:false,gridToolbar:false,filterModel:[],formtype:"horizontal",autosearch:true,formclass:"filterform",tableclass:"filtertable",buttonclass:"filterbutton",searchButton:"Search",clearButton:"Clear",enableSearch:false,enableClear:false,beforeSearch:null,afterSearch:null,beforeClear:null,afterClear:null,url:"",marksearched:true},n||{});return this.each(function(){var r=this;this.p=n;if(this.p.filterModel.length===0&&this.p.gridModel===false){alert("No filter is set");return}if(!t){alert("No target grid is set!");return}this.p.gridid=t.indexOf("#")!=-1?t:"#"+t;var i=e(this.p.gridid).jqGrid("getGridParam","colModel");if(i){if(this.p.gridModel===true){var s=e(this.p.gridid)[0];var o;e.each(i,function(e,t){var n=[];this.search=this.search===false?false:true;if(this.editrules&&this.editrules.searchhidden===true){o=true}else{if(this.hidden===true){o=false}else{o=true}}if(this.search===true&&o===true){if(r.p.gridNames===true){n.label=s.p.colNames[e]}else{n.label=""}n.name=this.name;n.index=this.index||this.name;n.stype=this.edittype||"text";if(n.stype!="select"){n.stype="text"}n.defval=this.defval||"";n.surl=this.surl||"";n.sopt=this.editoptions||{};n.width=this.width;r.p.filterModel.push(n)}})}else{e.each(r.p.filterModel,function(e,t){for(var n=0;n<i.length;n++){if(this.name==i[n].name){this.index=i[n].index||this.name;break}}if(!this.index){this.index=this.name}})}}else{alert("Could not get grid colModel");return}var u=function(){var t={},n=0,i;var s=e(r.p.gridid)[0],o;s.p.searchdata={};if(e.isFunction(r.p.beforeSearch)){r.p.beforeSearch()}e.each(r.p.filterModel,function(u,a){o=this.index;if(this.stype==="select"){i=e("select[name="+o+"]",r).val();if(i){t[o]=i;if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).addClass("dirty-cell")}n++}else{if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).removeClass("dirty-cell")}try{delete s.p.postData[this.index]}catch(f){}}}else{i=e("input[name="+o+"]",r).val();if(i){t[o]=i;if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).addClass("dirty-cell")}n++}else{if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).removeClass("dirty-cell")}try{delete s.p.postData[this.index]}catch(l){}}}});var u=n>0?true:false;e.extend(s.p.postData,t);var a;if(r.p.url){a=e(s).jqGrid("getGridParam","url");e(s).jqGrid("setGridParam",{url:r.p.url})}e(s).jqGrid("setGridParam",{search:u}).trigger("reloadGrid",[{page:1}]);if(a){e(s).jqGrid("setGridParam",{url:a})}if(e.isFunction(r.p.afterSearch)){r.p.afterSearch()}};var a=function(){var t={},n,i=0;var s=e(r.p.gridid)[0],o;if(e.isFunction(r.p.beforeClear)){r.p.beforeClear()}e.each(r.p.filterModel,function(u,a){o=this.index;n=this.defval?this.defval:"";if(!this.stype){this.stype="text"}switch(this.stype){case"select":var f;e("select[name="+o+"] option",r).each(function(t){if(t===0){this.selected=true}if(e(this).text()==n){this.selected=true;f=e(this).val();return false}});if(f){t[o]=f;if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).addClass("dirty-cell")}i++}else{if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).removeClass("dirty-cell")}try{delete s.p.postData[this.index]}catch(l){}}break;case"text":e("input[name="+o+"]",r).val(n);if(n){t[o]=n;if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).addClass("dirty-cell")}i++}else{if(r.p.marksearched){e("#jqgh_"+this.name,s.grid.hDiv).removeClass("dirty-cell")}try{delete s.p.postData[this.index]}catch(c){}}break}});var u=i>0?true:false;e.extend(s.p.postData,t);var a;if(r.p.url){a=e(s).jqGrid("getGridParam","url");e(s).jqGrid("setGridParam",{url:r.p.url})}e(s).jqGrid("setGridParam",{search:u}).trigger("reloadGrid",[{page:1}]);if(a){e(s).jqGrid("setGridParam",{url:a})}if(e.isFunction(r.p.afterClear)){r.p.afterClear()}};var f;var l=function(){var t=document.createElement("tr");var n,i,s,o,l;if(r.p.formtype=="horizontal"){e(f).append(t)}e.each(r.p.filterModel,function(i,s){o=document.createElement("td");e(o).append("<label for='"+this.name+"'>"+this.label+"</label>");l=document.createElement("td");var a=this;if(!this.stype){this.stype="text"}switch(this.stype){case"select":if(this.surl){e(l).load(this.surl,function(){if(a.defval){e("select",this).val(a.defval)}e("select",this).attr({name:a.index||a.name,id:"sg_"+a.name});if(a.sopt){e("select",this).attr(a.sopt)}if(r.p.gridToolbar===true&&a.width){e("select",this).width(a.width)}if(r.p.autosearch===true){e("select",this).change(function(e){u();return false})}})}else{if(a.sopt.value){var c=a.sopt.value;var h=document.createElement("select");e(h).attr({name:a.index||a.name,id:"sg_"+a.name}).attr(a.sopt);var p,d,v;if(typeof c==="string"){p=c.split(";");for(var m=0;m<p.length;m++){d=p[m].split(":");v=document.createElement("option");v.value=d[0];v.innerHTML=d[1];if(d[1]==a.defval){v.selected="selected"}h.appendChild(v)}}else if(typeof c==="object"){for(var g in c){if(c.hasOwnProperty(g)){i++;v=document.createElement("option");v.value=g;v.innerHTML=c[g];if(c[g]==a.defval){v.selected="selected"}h.appendChild(v)}}}if(r.p.gridToolbar===true&&a.width){e(h).width(a.width)}e(l).append(h);if(r.p.autosearch===true){e(h).change(function(e){u();return false})}}}break;case"text":var y=this.defval?this.defval:"";e(l).append("<input type='text' name='"+(this.index||this.name)+"' id='sg_"+this.name+"' value='"+y+"'/>");if(a.sopt){e("input",l).attr(a.sopt)}if(r.p.gridToolbar===true&&a.width){if(e.browser.msie){e("input",l).width(a.width-4)}else{e("input",l).width(a.width-2)}}if(r.p.autosearch===true){e("input",l).keypress(function(e){var t=e.charCode?e.charCode:e.keyCode?e.keyCode:0;if(t==13){u();return false}return this})}break}if(r.p.formtype=="horizontal"){if(r.p.gridToolbar===true&&r.p.gridNames===false){e(t).append(l)}else{e(t).append(o).append(l)}e(t).append(l)}else{n=document.createElement("tr");e(n).append(o).append(l);e(f).append(n)}});l=document.createElement("td");if(r.p.enableSearch===true){i="<input type='button' id='sButton' class='"+r.p.buttonclass+"' value='"+r.p.searchButton+"'/>";e(l).append(i);e("input#sButton",l).click(function(){u();return false})}if(r.p.enableClear===true){s="<input type='button' id='cButton' class='"+r.p.buttonclass+"' value='"+r.p.clearButton+"'/>";e(l).append(s);e("input#cButton",l).click(function(){a();return false})}if(r.p.enableClear===true||r.p.enableSearch===true){if(r.p.formtype=="horizontal"){e(t).append(l)}else{n=document.createElement("tr");e(n).append("<td>&#160;</td>").append(l);e(f).append(n)}}};var c=e("<form name='SearchForm' style=display:inline;' class='"+this.p.formclass+"'></form>");f=e("<table class='"+this.p.tableclass+"' cellspacing='0' cellpading='0' border='0'><tbody></tbody></table>");e(c).append(f);l();e(this).append(c);this.triggerSearch=u;this.clearSearch=a})}})})(jQuery)