(function(e){"use strict";e.fn.jqFilter=function(t){if(typeof t==="string"){var n=e.fn.jqFilter[t];if(!n){throw"jqFilter - No such method: "+t}var r=e.makeArray(arguments).slice(1);return n.apply(this,r)}var i=e.extend(true,{filter:null,columns:[],onChange:null,afterRedraw:null,checkValues:null,error:false,errmsg:"",errorcheck:true,showQuery:true,sopt:null,ops:[],operands:null,numopts:["eq","ne","lt","le","gt","ge","nu","nn","in","ni"],stropts:["eq","ne","bw","bn","ew","en","cn","nc","nu","nn","in","ni"],strarr:["text","string","blob"],groupOps:[{op:"AND",text:"AND"},{op:"OR",text:"OR"}],groupButton:true,ruleButtons:true,direction:"ltr"},e.jgrid.filter,t||{});return this.each(function(){if(this.filter){return}this.p=i;if(this.p.filter===null||this.p.filter===undefined){this.p.filter={groupOp:this.p.groupOps[0].op,rules:[],groups:[]}}var t,n=this.p.columns.length,r,s=/msie/i.test(navigator.userAgent)&&!window.opera;this.p.initFilter=e.extend(true,{},this.p.filter);if(!n){return}for(t=0;t<n;t++){r=this.p.columns[t];if(r.stype){r.inputtype=r.stype}else if(!r.inputtype){r.inputtype="text"}if(r.sorttype){r.searchtype=r.sorttype}else if(!r.searchtype){r.searchtype="string"}if(r.hidden===undefined){r.hidden=false}if(!r.label){r.label=r.name}if(r.index){r.name=r.index}if(!r.hasOwnProperty("searchoptions")){r.searchoptions={}}if(!r.hasOwnProperty("searchrules")){r.searchrules={}}}if(this.p.showQuery){e(this).append("<table class='queryresult ui-widget ui-widget-content' style='display:block;max-width:440px;border:0px none;' dir='"+this.p.direction+"'><tbody><tr><td class='query'></td></tr></tbody></table>")}var o=function(){return e("#"+e.jgrid.jqID(i.id))[0]||null};var u=function(t,n){var r=[true,""],s=o();if(e.isFunction(n.searchrules)){r=n.searchrules.call(s,t,n)}else if(e.jgrid&&e.jgrid.checkValues){try{r=e.jgrid.checkValues.call(s,t,-1,n.searchrules,n.label)}catch(u){}}if(r&&r.length&&r[0]===false){i.error=!r[0];i.errmsg=r[1]}};this.onchange=function(){this.p.error=false;this.p.errmsg="";return e.isFunction(this.p.onChange)?this.p.onChange.call(this,this.p):false};this.reDraw=function(){e("table.group:first",this).remove();var t=this.createTableForGroup(i.filter,null);e(this).append(t);if(e.isFunction(this.p.afterRedraw)){this.p.afterRedraw.call(this,this.p)}};this.createTableForGroup=function(t,n){var r=this,s;var o=e("<table class='group ui-widget ui-widget-content' style='border:0px none;'><tbody></tbody></table>"),u="left";if(this.p.direction==="rtl"){u="right";o.attr("dir","rtl")}if(n===null){o.append("<tr class='error' style='display:none;'><th colspan='5' class='ui-state-error' align='"+u+"'></th></tr>")}var a=e("<tr></tr>");o.append(a);var f=e("<th colspan='5' align='"+u+"'></th>");a.append(f);if(this.p.ruleButtons===true){var l=e("<select class='opsel'></select>");f.append(l);var c="",h;for(s=0;s<i.groupOps.length;s++){h=t.groupOp===r.p.groupOps[s].op?" selected='selected'":"";c+="<option value='"+r.p.groupOps[s].op+"'"+h+">"+r.p.groupOps[s].text+"</option>"}l.append(c).bind("change",function(){t.groupOp=e(l).val();r.onchange()})}var d="<span></span>";if(this.p.groupButton){d=e("<input type='button' value='+ {}' title='Add subgroup' class='add-group'/>");d.bind("click",function(){if(t.groups===undefined){t.groups=[]}t.groups.push({groupOp:i.groupOps[0].op,rules:[],groups:[]});r.reDraw();r.onchange();return false})}f.append(d);if(this.p.ruleButtons===true){var v=e("<input type='button' value='+' title='Add rule' class='add-rule ui-add'/>"),m;v.bind("click",function(){if(t.rules===undefined){t.rules=[]}for(s=0;s<r.p.columns.length;s++){var n=r.p.columns[s].search===undefined?true:r.p.columns[s].search,i=r.p.columns[s].hidden===true,o=r.p.columns[s].searchoptions.searchhidden===true;if(o&&n||n&&!i){m=r.p.columns[s];break}}var u;if(m.searchoptions.sopt){u=m.searchoptions.sopt}else if(r.p.sopt){u=r.p.sopt}else if(e.inArray(m.searchtype,r.p.strarr)!==-1){u=r.p.stropts}else{u=r.p.numopts}t.rules.push({field:m.name,op:u[0],data:""});r.reDraw();return false});f.append(v)}if(n!==null){var g=e("<input type='button' value='-' title='Delete group' class='delete-group'/>");f.append(g);g.bind("click",function(){for(s=0;s<n.groups.length;s++){if(n.groups[s]===t){n.groups.splice(s,1);break}}r.reDraw();r.onchange();return false})}if(t.groups!==undefined){for(s=0;s<t.groups.length;s++){var y=e("<tr></tr>");o.append(y);var b=e("<td class='first'></td>");y.append(b);var w=e("<td colspan='4'></td>");w.append(this.createTableForGroup(t.groups[s],t));y.append(w)}}if(t.groupOp===undefined){t.groupOp=r.p.groupOps[0].op}if(t.rules!==undefined){for(s=0;s<t.rules.length;s++){o.append(this.createTableRowForRule(t.rules[s],t))}}return o};this.createTableRowForRule=function(t,n){var r=this,u=o(),a=e("<tr></tr>"),f,l,c,h,d="",v;a.append("<td class='first'></td>");var m=e("<td class='columns'></td>");a.append(m);var g=e("<select></select>"),y,b=[];m.append(g);g.bind("change",function(){t.field=e(g).val();c=e(this).parents("tr:first");for(f=0;f<r.p.columns.length;f++){if(r.p.columns[f].name===t.field){h=r.p.columns[f];break}}if(!h){return}h.searchoptions.id=e.jgrid.randId();if(s&&h.inputtype==="text"){if(!h.searchoptions.size){h.searchoptions.size=10}}var n=e.jgrid.createEl.call(u,h.inputtype,h.searchoptions,"",true,r.p.ajaxSelectOptions||{},true);e(n).addClass("input-elm");if(h.searchoptions.sopt){l=h.searchoptions.sopt}else if(r.p.sopt){l=r.p.sopt}else if(e.inArray(h.searchtype,r.p.strarr)!==-1){l=r.p.stropts}else{l=r.p.numopts}var i="",o=0;b=[];e.each(r.p.ops,function(){b.push(this.oper)});for(f=0;f<l.length;f++){y=e.inArray(l[f],b);if(y!==-1){if(o===0){t.op=r.p.ops[y].oper}i+="<option value='"+r.p.ops[y].oper+"'>"+r.p.ops[y].text+"</option>";o++}}e(".selectopts",c).empty().append(i);e(".selectopts",c)[0].selectedIndex=0;if(e.jgrid.msie&&e.jgrid.msiever()<9){var a=parseInt(e("select.selectopts",c)[0].offsetWidth,10)+1;e(".selectopts",c).width(a);e(".selectopts",c).css("width","auto")}e(".data",c).empty().append(n);e.jgrid.bindEv.call(u,n,h.searchoptions);e(".input-elm",c).bind("change",function(n){var i=n.target;t.data=i.nodeName.toUpperCase()==="SPAN"&&h.searchoptions&&e.isFunction(h.searchoptions.custom_value)?h.searchoptions.custom_value.call(u,e(i).children(".customelement:first"),"get"):i.value;r.onchange()});setTimeout(function(){t.data=e(n).val();r.onchange()},0)});var w=0;for(f=0;f<r.p.columns.length;f++){var E=r.p.columns[f].search===undefined?true:r.p.columns[f].search,S=r.p.columns[f].hidden===true,x=r.p.columns[f].searchoptions.searchhidden===true;if(x&&E||E&&!S){v="";if(t.field===r.p.columns[f].name){v=" selected='selected'";w=f}d+="<option value='"+r.p.columns[f].name+"'"+v+">"+r.p.columns[f].label+"</option>"}}g.append(d);var T=e("<td class='operators'></td>");a.append(T);h=i.columns[w];h.searchoptions.id=e.jgrid.randId();if(s&&h.inputtype==="text"){if(!h.searchoptions.size){h.searchoptions.size=10}}var N=e.jgrid.createEl.call(u,h.inputtype,h.searchoptions,t.data,true,r.p.ajaxSelectOptions||{},true);if(t.op==="nu"||t.op==="nn"){e(N).attr("readonly","true");e(N).attr("disabled","true")}var C=e("<select class='selectopts'></select>");T.append(C);C.bind("change",function(){t.op=e(C).val();c=e(this).parents("tr:first");var n=e(".input-elm",c)[0];if(t.op==="nu"||t.op==="nn"){t.data="";if(n.tagName.toUpperCase()!=="SELECT")n.value="";n.setAttribute("readonly","true");n.setAttribute("disabled","true")}else{if(n.tagName.toUpperCase()==="SELECT")t.data=n.value;n.removeAttribute("readonly");n.removeAttribute("disabled")}r.onchange()});if(h.searchoptions.sopt){l=h.searchoptions.sopt}else if(r.p.sopt){l=r.p.sopt}else if(e.inArray(h.searchtype,r.p.strarr)!==-1){l=r.p.stropts}else{l=r.p.numopts}d="";e.each(r.p.ops,function(){b.push(this.oper)});for(f=0;f<l.length;f++){y=e.inArray(l[f],b);if(y!==-1){v=t.op===r.p.ops[y].oper?" selected='selected'":"";d+="<option value='"+r.p.ops[y].oper+"'"+v+">"+r.p.ops[y].text+"</option>"}}C.append(d);var k=e("<td class='data'></td>");a.append(k);k.append(N);e.jgrid.bindEv.call(u,N,h.searchoptions);e(N).addClass("input-elm").bind("change",function(){t.data=h.inputtype==="custom"?h.searchoptions.custom_value.call(u,e(this).children(".customelement:first"),"get"):e(this).val();r.onchange()});var L=e("<td></td>");a.append(L);if(this.p.ruleButtons===true){var A=e("<input type='button' value='-' title='Delete rule' class='delete-rule ui-del'/>");L.append(A);A.bind("click",function(){for(f=0;f<n.rules.length;f++){if(n.rules[f]===t){n.rules.splice(f,1);break}}r.reDraw();r.onchange();return false})}return a};this.getStringForGroup=function(e){var t="(",n;if(e.groups!==undefined){for(n=0;n<e.groups.length;n++){if(t.length>1){t+=" "+e.groupOp+" "}try{t+=this.getStringForGroup(e.groups[n])}catch(r){alert(r)}}}if(e.rules!==undefined){try{for(n=0;n<e.rules.length;n++){if(t.length>1){t+=" "+e.groupOp+" "}t+=this.getStringForRule(e.rules[n])}}catch(i){alert(i)}}t+=")";if(t==="()"){return""}return t};this.getStringForRule=function(t){var n="",r="",s,o,a,f,l=["int","integer","float","number","currency"];for(s=0;s<this.p.ops.length;s++){if(this.p.ops[s].oper===t.op){n=this.p.operands.hasOwnProperty(t.op)?this.p.operands[t.op]:"";r=this.p.ops[s].oper;break}}for(s=0;s<this.p.columns.length;s++){if(this.p.columns[s].name===t.field){o=this.p.columns[s];break}}if(o==undefined){return""}f=t.data;if(r==="bw"||r==="bn"){f=f+"%"}if(r==="ew"||r==="en"){f="%"+f}if(r==="cn"||r==="nc"){f="%"+f+"%"}if(r==="in"||r==="ni"){f=" ("+f+")"}if(i.errorcheck){u(t.data,o)}if(e.inArray(o.searchtype,l)!==-1||r==="nn"||r==="nu"){a=t.field+" "+n+" "+f}else{a=t.field+" "+n+' "'+f+'"'}return a};this.resetFilter=function(){this.p.filter=e.extend(true,{},this.p.initFilter);this.reDraw();this.onchange()};this.hideError=function(){e("th.ui-state-error",this).html("");e("tr.error",this).hide()};this.showError=function(){e("th.ui-state-error",this).html(this.p.errmsg);e("tr.error",this).show()};this.toUserFriendlyString=function(){return this.getStringForGroup(i.filter)};this.toString=function(){function t(t){if(e.p.errorcheck){var n,r;for(n=0;n<e.p.columns.length;n++){if(e.p.columns[n].name===t.field){r=e.p.columns[n];break}}if(r){u(t.data,r)}}return t.op+"(item."+t.field+",'"+t.data+"')"}function n(e){var r="(",i;if(e.groups!==undefined){for(i=0;i<e.groups.length;i++){if(r.length>1){if(e.groupOp==="OR"){r+=" || "}else{r+=" && "}}r+=n(e.groups[i])}}if(e.rules!==undefined){for(i=0;i<e.rules.length;i++){if(r.length>1){if(e.groupOp==="OR"){r+=" || "}else{r+=" && "}}r+=t(e.rules[i])}}r+=")";if(r==="()"){return""}return r}var e=this;return n(this.p.filter)};this.reDraw();if(this.p.showQuery){this.onchange()}this.filter=true})};e.extend(e.fn.jqFilter,{toSQLString:function(){var e="";this.each(function(){e=this.toUserFriendlyString()});return e},filterData:function(){var e;this.each(function(){e=this.p.filter});return e},getParameter:function(e){if(e!==undefined){if(this.p.hasOwnProperty(e)){return this.p[e]}}return this.p},resetFilter:function(){return this.each(function(){this.resetFilter()})},addFilter:function(t){if(typeof t==="string"){t=e.jgrid.parse(t)}this.each(function(){this.p.filter=t;this.reDraw();this.onchange()})}})})(jQuery)