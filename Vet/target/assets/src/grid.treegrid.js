(function(e){"use strict";e.jgrid.extend({setTreeNode:function(t,n){return this.each(function(){var r=this;if(!r.grid||!r.p.treeGrid){return}var s=r.p.expColInd,o=r.p.treeReader.expanded_field,u=r.p.treeReader.leaf_field,a=r.p.treeReader.level_field,f=r.p.treeReader.icon_field,l=r.p.treeReader.loaded,c,h,p,d,v,m,g,y;while(t<n){var b=e.jgrid.stripPref(r.p.idPrefix,r.rows[t].id),w=r.p._index[b],E;g=r.p.data[w];if(r.p.treeGridModel==="nested"){if(!g[u]){c=parseInt(g[r.p.treeReader.left_field],10);h=parseInt(g[r.p.treeReader.right_field],10);g[u]=h===c+1?"true":"false";r.rows[t].cells[r.p._treeleafpos].innerHTML=g[u]}}p=parseInt(g[a],10);if(r.p.tree_root_level===0){d=p+1;v=p}else{d=p;v=p-1}m="<div class='tree-wrap tree-wrap-"+r.p.direction+"' style='width:"+d*18+"px;'>";m+="<div style='"+(r.p.direction==="rtl"?"right:":"left:")+v*18+"px;' class='ui-icon ";if(g[l]!==undefined){if(g[l]==="true"||g[l]===true){g[l]=true}else{g[l]=false}}if(g[u]==="true"||g[u]===true){m+=(g[f]!==undefined&&g[f]!==""?g[f]:r.p.treeIcons.leaf)+" tree-leaf treeclick";g[u]=true;y="leaf"}else{g[u]=false;y=""}g[o]=(g[o]==="true"||g[o]===true?true:false)&&(g[l]||g[l]===undefined);if(g[o]===false){m+=g[u]===true?"'":r.p.treeIcons.plus+" tree-plus treeclick'"}else{m+=g[u]===true?"'":r.p.treeIcons.minus+" tree-minus treeclick'"}m+="></div></div>";e(r.rows[t].cells[s]).wrapInner("<span class='cell-wrapper"+y+"'></span>").prepend(m);if(p!==parseInt(r.p.tree_root_level,10)){var S=e(r).jqGrid("getNodeParent",g);E=S&&S.hasOwnProperty(o)?S[o]:true;if(!E){e(r.rows[t]).css("display","none")}}e(r.rows[t].cells[s]).find("div.treeclick").bind("click",function(t){var n=t.target||t.srcElement,i=e.jgrid.stripPref(r.p.idPrefix,e(n,r.rows).closest("tr.jqgrow")[0].id),s=r.p._index[i];if(!r.p.data[s][u]){if(r.p.data[s][o]){e(r).jqGrid("collapseRow",r.p.data[s]);e(r).jqGrid("collapseNode",r.p.data[s])}else{e(r).jqGrid("expandRow",r.p.data[s]);e(r).jqGrid("expandNode",r.p.data[s])}}return false});if(r.p.ExpandColClick===true){e(r.rows[t].cells[s]).find("span.cell-wrapper").css("cursor","pointer").bind("click",function(t){var n=t.target||t.srcElement,i=e.jgrid.stripPref(r.p.idPrefix,e(n,r.rows).closest("tr.jqgrow")[0].id),s=r.p._index[i];if(!r.p.data[s][u]){if(r.p.data[s][o]){e(r).jqGrid("collapseRow",r.p.data[s]);e(r).jqGrid("collapseNode",r.p.data[s])}else{e(r).jqGrid("expandRow",r.p.data[s]);e(r).jqGrid("expandNode",r.p.data[s])}}e(r).jqGrid("setSelection",i);return false})}t++}})},setTreeGrid:function(){return this.each(function(){var t=this,n=0,r,i=false,s,o,u,a=[];if(!t.p.treeGrid){return}if(!t.p.treedatatype){e.extend(t.p,{treedatatype:t.p.datatype})}t.p.subGrid=false;t.p.altRows=false;t.p.pgbuttons=false;t.p.pginput=false;t.p.gridview=true;if(t.p.rowTotal===null){t.p.rowNum=1e4}t.p.multiselect=false;t.p.rowList=[];t.p.expColInd=0;r="ui-icon-triangle-1-"+(t.p.direction==="rtl"?"w":"e");t.p.treeIcons=e.extend({plus:r,minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},t.p.treeIcons||{});if(t.p.treeGridModel==="nested"){t.p.treeReader=e.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},t.p.treeReader)}else if(t.p.treeGridModel==="adjacency"){t.p.treeReader=e.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},t.p.treeReader)}for(o in t.p.colModel){if(t.p.colModel.hasOwnProperty(o)){s=t.p.colModel[o].name;if(s===t.p.ExpandColumn&&!i){i=true;t.p.expColInd=n}n++;for(u in t.p.treeReader){if(t.p.treeReader.hasOwnProperty(u)&&t.p.treeReader[u]===s){a.push(s)}}}}e.each(t.p.treeReader,function(r,i){if(i&&e.inArray(i,a)===-1){if(r==="leaf_field"){t.p._treeleafpos=n}n++;t.p.colNames.push(i);t.p.colModel.push({name:i,width:1,hidden:true,sortable:false,resizable:false,hidedlg:true,editable:true,search:false})}})})},expandRow:function(t){this.each(function(){var n=this;if(!n.grid||!n.p.treeGrid){return}var r=e(n).jqGrid("getNodeChildren",t),i=n.p.treeReader.expanded_field;e(r).each(function(){var t=n.p.idPrefix+e.jgrid.getAccessor(this,n.p.localReader.id);e(e(n).jqGrid("getGridRowById",t)).css("display","");if(this[i]){e(n).jqGrid("expandRow",this)}})})},collapseRow:function(t){this.each(function(){var n=this;if(!n.grid||!n.p.treeGrid){return}var r=e(n).jqGrid("getNodeChildren",t),i=n.p.treeReader.expanded_field;e(r).each(function(){var t=n.p.idPrefix+e.jgrid.getAccessor(this,n.p.localReader.id);e(e(n).jqGrid("getGridRowById",t)).css("display","none");if(this[i]){e(n).jqGrid("collapseRow",this)}})})},getRootNodes:function(){var t=[];this.each(function(){var n=this;if(!n.grid||!n.p.treeGrid){return}switch(n.p.treeGridModel){case"nested":var r=n.p.treeReader.level_field;e(n.p.data).each(function(){if(parseInt(this[r],10)===parseInt(n.p.tree_root_level,10)){t.push(this)}});break;case"adjacency":var i=n.p.treeReader.parent_id_field;e(n.p.data).each(function(){if(this[i]===null||String(this[i]).toLowerCase()==="null"){t.push(this)}});break}});return t},getNodeDepth:function(t){var n=null;this.each(function(){if(!this.grid||!this.p.treeGrid){return}var r=this;switch(r.p.treeGridModel){case"nested":var i=r.p.treeReader.level_field;n=parseInt(t[i],10)-parseInt(r.p.tree_root_level,10);break;case"adjacency":n=e(r).jqGrid("getNodeAncestors",t).length;break}});return n},getNodeParent:function(t){var n=null;this.each(function(){var r=this;if(!r.grid||!r.p.treeGrid){return}switch(r.p.treeGridModel){case"nested":var i=r.p.treeReader.left_field,s=r.p.treeReader.right_field,o=r.p.treeReader.level_field,u=parseInt(t[i],10),a=parseInt(t[s],10),f=parseInt(t[o],10);e(this.p.data).each(function(){if(parseInt(this[o],10)===f-1&&parseInt(this[i],10)<u&&parseInt(this[s],10)>a){n=this;return false}});break;case"adjacency":var l=r.p.treeReader.parent_id_field,c=r.p.localReader.id;e(this.p.data).each(function(){if(this[c]===e.jgrid.stripPref(r.p.idPrefix,t[l])){n=this;return false}});break}});return n},getNodeChildren:function(t){var n=[];this.each(function(){var r=this;if(!r.grid||!r.p.treeGrid){return}switch(r.p.treeGridModel){case"nested":var i=r.p.treeReader.left_field,s=r.p.treeReader.right_field,o=r.p.treeReader.level_field,u=parseInt(t[i],10),a=parseInt(t[s],10),f=parseInt(t[o],10);e(this.p.data).each(function(){if(parseInt(this[o],10)===f+1&&parseInt(this[i],10)>u&&parseInt(this[s],10)<a){n.push(this)}});break;case"adjacency":var l=r.p.treeReader.parent_id_field,c=r.p.localReader.id;e(this.p.data).each(function(){if(this[l]==e.jgrid.stripPref(r.p.idPrefix,t[c])){n.push(this)}});break}});return n},getFullTreeNode:function(t){var n=[];this.each(function(){var r=this,i;if(!r.grid||!r.p.treeGrid){return}switch(r.p.treeGridModel){case"nested":var s=r.p.treeReader.left_field,o=r.p.treeReader.right_field,u=r.p.treeReader.level_field,a=parseInt(t[s],10),f=parseInt(t[o],10),l=parseInt(t[u],10);e(this.p.data).each(function(){if(parseInt(this[u],10)>=l&&parseInt(this[s],10)>=a&&parseInt(this[s],10)<=f){n.push(this)}});break;case"adjacency":if(t){n.push(t);var c=r.p.treeReader.parent_id_field,h=r.p.localReader.id;e(this.p.data).each(function(t){i=n.length;for(t=0;t<i;t++){if(e.jgrid.stripPref(r.p.idPrefix,n[t][h])===this[c]){n.push(this);break}}})}break}});return n},getNodeAncestors:function(t){var n=[];this.each(function(){if(!this.grid||!this.p.treeGrid){return}var r=e(this).jqGrid("getNodeParent",t);while(r){n.push(r);r=e(this).jqGrid("getNodeParent",r)}});return n},isVisibleNode:function(t){var n=true;this.each(function(){var r=this;if(!r.grid||!r.p.treeGrid){return}var i=e(r).jqGrid("getNodeAncestors",t),s=r.p.treeReader.expanded_field;e(i).each(function(){n=n&&this[s];if(!n){return false}})});return n},isNodeLoaded:function(t){var n;this.each(function(){var r=this;if(!r.grid||!r.p.treeGrid){return}var i=r.p.treeReader.leaf_field,s=r.p.treeReader.loaded;if(t!==undefined){if(t[s]!==undefined){n=t[s]}else if(t[i]||e(r).jqGrid("getNodeChildren",t).length>0){n=true}else{n=false}}else{n=false}});return n},expandNode:function(t){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var n=this.p.treeReader.expanded_field,r=this.p.treeReader.parent_id_field,i=this.p.treeReader.loaded,s=this.p.treeReader.level_field,o=this.p.treeReader.left_field,u=this.p.treeReader.right_field;if(!t[n]){var a=e.jgrid.getAccessor(t,this.p.localReader.id);var f=e("#"+this.p.idPrefix+e.jgrid.jqID(a),this.grid.bDiv)[0];var l=this.p._index[a];if(e(this).jqGrid("isNodeLoaded",this.p.data[l])){t[n]=true;e("div.treeclick",f).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")}else if(!this.grid.hDiv.loading){t[n]=true;e("div.treeclick",f).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus");this.p.treeANode=f.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel==="nested"){e(this).jqGrid("setGridParam",{postData:{nodeid:a,n_left:t[o],n_right:t[u],n_level:t[s]}})}else{e(this).jqGrid("setGridParam",{postData:{nodeid:a,parentid:t[r],n_level:t[s]}})}e(this).trigger("reloadGrid");t[i]=true;if(this.p.treeGridModel==="nested"){e(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}})}else{e(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}})}}}})},collapseNode:function(t){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var n=this.p.treeReader.expanded_field;if(t[n]){t[n]=false;var r=e.jgrid.getAccessor(t,this.p.localReader.id);var i=e("#"+this.p.idPrefix+e.jgrid.jqID(r),this.grid.bDiv)[0];e("div.treeclick",i).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}})},SortTree:function(t,n,r,i){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var s,o,u,a=[],f=this,l,c,h=e(this).jqGrid("getRootNodes");l=e.jgrid.from(h);l.orderBy(t,n,r,i);c=l.select();for(s=0,o=c.length;s<o;s++){u=c[s];a.push(u);e(this).jqGrid("collectChildrenSortTree",a,u,t,n,r,i)}e.each(a,function(t){var n=e.jgrid.getAccessor(this,f.p.localReader.id);e("#"+e.jgrid.jqID(f.p.id)+" tbody tr:eq("+t+")").after(e("tr#"+e.jgrid.jqID(n),f.grid.bDiv))});l=null;c=null;a=null})},collectChildrenSortTree:function(t,n,r,i,s,o){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var u,a,f,l,c,h;l=e(this).jqGrid("getNodeChildren",n);c=e.jgrid.from(l);c.orderBy(r,i,s,o);h=c.select();for(u=0,a=h.length;u<a;u++){f=h[u];t.push(f);e(this).jqGrid("collectChildrenSortTree",t,f,r,i,s,o)}})},setTreeRow:function(t,n){var r=false;this.each(function(){var i=this;if(!i.grid||!i.p.treeGrid){return}r=e(i).jqGrid("setRowData",t,n)});return r},delTreeNode:function(t){return this.each(function(){var n=this,r=n.p.localReader.id,i,s=n.p.treeReader.left_field,o=n.p.treeReader.right_field,u,a,f,l;if(!n.grid||!n.p.treeGrid){return}var c=n.p._index[t];if(c!==undefined){u=parseInt(n.p.data[c][o],10);a=u-parseInt(n.p.data[c][s],10)+1;var h=e(n).jqGrid("getFullTreeNode",n.p.data[c]);if(h.length>0){for(i=0;i<h.length;i++){e(n).jqGrid("delRowData",h[i][r])}}if(n.p.treeGridModel==="nested"){f=e.jgrid.from(n.p.data).greater(s,u,{stype:"integer"}).select();if(f.length){for(l in f){if(f.hasOwnProperty(l)){f[l][s]=parseInt(f[l][s],10)-a}}}f=e.jgrid.from(n.p.data).greater(o,u,{stype:"integer"}).select();if(f.length){for(l in f){if(f.hasOwnProperty(l)){f[l][o]=parseInt(f[l][o],10)-a}}}}}})},addChildNode:function(t,n,r,i){var s=this[0];if(r){var o=s.p.treeReader.expanded_field,u=s.p.treeReader.leaf_field,a=s.p.treeReader.level_field,f=s.p.treeReader.parent_id_field,l=s.p.treeReader.left_field,c=s.p.treeReader.right_field,h=s.p.treeReader.loaded,p,d,v,m,g,y,b=0,w=n,E,S;if(i===undefined){i=false}if(t===undefined||t===null){g=s.p.data.length-1;if(g>=0){while(g>=0){b=Math.max(b,parseInt(s.p.data[g][s.p.localReader.id],10));g--}}t=b+1}var x=e(s).jqGrid("getInd",n);E=false;if(n===undefined||n===null||n===""){n=null;w=null;p="last";m=s.p.tree_root_level;g=s.p.data.length+1}else{p="after";d=s.p._index[n];v=s.p.data[d];n=v[s.p.localReader.id];m=parseInt(v[a],10)+1;var T=e(s).jqGrid("getFullTreeNode",v);if(T.length){g=T[T.length-1][s.p.localReader.id];w=g;g=e(s).jqGrid("getInd",w)+1}else{g=e(s).jqGrid("getInd",n)+1}if(v[u]){E=true;v[o]=true;e(s.rows[x]).find("span.cell-wrapperleaf").removeClass("cell-wrapperleaf").addClass("cell-wrapper").end().find("div.tree-leaf").removeClass(s.p.treeIcons.leaf+" tree-leaf").addClass(s.p.treeIcons.minus+" tree-minus");s.p.data[d][u]=false;v[h]=true}}y=g+1;if(r[o]===undefined){r[o]=false}if(r[h]===undefined){r[h]=false}r[a]=m;if(r[u]===undefined){r[u]=true}if(s.p.treeGridModel==="adjacency"){r[f]=n}if(s.p.treeGridModel==="nested"){var N,C,k;if(n!==null){S=parseInt(v[c],10);N=e.jgrid.from(s.p.data);N=N.greaterOrEquals(c,S,{stype:"integer"});C=N.select();if(C.length){for(k in C){if(C.hasOwnProperty(k)){C[k][l]=C[k][l]>S?parseInt(C[k][l],10)+2:C[k][l];C[k][c]=C[k][c]>=S?parseInt(C[k][c],10)+2:C[k][c]}}}r[l]=S;r[c]=S+1}else{S=parseInt(e(s).jqGrid("getCol",c,false,"max"),10);C=e.jgrid.from(s.p.data).greater(l,S,{stype:"integer"}).select();if(C.length){for(k in C){if(C.hasOwnProperty(k)){C[k][l]=parseInt(C[k][l],10)+2}}}C=e.jgrid.from(s.p.data).greater(c,S,{stype:"integer"}).select();if(C.length){for(k in C){if(C.hasOwnProperty(k)){C[k][c]=parseInt(C[k][c],10)+2}}}r[l]=S+1;r[c]=S+2}}if(n===null||e(s).jqGrid("isNodeLoaded",v)||E){e(s).jqGrid("addRowData",t,r,p,w);e(s).jqGrid("setTreeNode",g,y)}if(v&&!v[o]&&i){e(s.rows[x]).find("div.treeclick").click()}}}})})(jQuery)